#!/usr/bin/env bash
# Author: cipherodio
# Description: Handle URLs via rofi chooser

set -euo pipefail

exec 2>/dev/null

url=${1-}
[[ -n $url ]] || exit 0

choices=(
    copy
    browser
    mpv
    download
    qb-ytv
    qb-yta
    nsxiv
)

program=$(
    printf '%s\n' "${choices[@]}" |
        rofi -dmenu -p 'Open with'
)

[[ -n ${program-} ]] || exit 0

case $program in
copy)
    printf '%s' "$url" | xclip -selection clipboard
    ;;

browser)
    setsid -f "${BROWSER:-firefox}" "$url"
    ;;

mpv)
    setsid -f mpv -quiet --profile=M60 "$url"
    ;;

download)
    (
        cd "$HOME/hub/downloads"
        curl -sLO "$url"
    ) &
    ;;

qb-ytv)
    notify-send "Youtube download" "started"
    yt-dlp \
        -f 'bestvideo+bestaudio' \
        --merge-output-format mp4 \
        --restrict-filenames \
        -o "$HOME/hub/downloads/%(title)s.%(ext)s" \
        "$url" &&
        notify-send "Youtube download" "finished" &
    ;;

qb-yta)
    notify-send "Youtube download" "started"
    yt-dlp \
        -x \
        --audio-format mp3 \
        --audio-quality 0 \
        --restrict-filenames \
        -o "$HOME/hub/downloads/%(title)s.%(ext)s" \
        "$url" &&
        notify-send "Youtube download" "finished" &
    ;;

nsxiv)
    file=${url##*/}
    tmp="/tmp/$file"
    curl -sL "$url" >"$tmp" &&
        nsxiv -ab "$tmp" &
    ;;
esac
