#!/usr/bin/env bash
# Author: cipherodio
# Description: Generate shell, zsh, and lf shortcuts from bookmark files

set -euo pipefail

# Input files
bmdirs="$XDG_CONFIG_HOME/shell/bm-dirs"
bmfiles="$XDG_CONFIG_HOME/shell/bm-files"

# Output files
shell_shortcuts="$XDG_CONFIG_HOME/shell/shrc"
zsh_named_dirs="$XDG_CONFIG_HOME/shell/zshdirrc"
lf_shortcuts="$XDG_CONFIG_HOME/lf/shrc"

# Reset outputs
rm -f "$zsh_named_dirs" "$lf_shortcuts"
printf "# vim: filetype=sh\nalias " >"$shell_shortcuts"

# Helper: read bookmarks
read_bookmarks() {
    while read -r key path _; do
        [[ -z $key || $key == \#* ]] && continue
        printf '%s\t%s\n' "$key" "$path"
    done <"$1"
}

# Directory bookmarks
while IFS=$'\t' read -r key path; do
    expanded_path=${path@P}

    printf "%s=\"cd %s\" \\\\\n" \
        "$key" "$expanded_path" >>"$shell_shortcuts"

    printf "hash -d %s=%s\n" \
        "$key" "$expanded_path" >>"$zsh_named_dirs"

    printf "map g%s cd \"%s\"\n" \
        "$key" "$expanded_path" >>"$lf_shortcuts"
done < <(read_bookmarks "$bmdirs")

# File bookmarks
while IFS=$'\t' read -r key path; do
    expanded_path=${path@P}

    # $EDITOR intentionally deferred
    printf "%s=\"\\\$EDITOR %s\" \\\\\n" \
        "$key" "$expanded_path" >>"$shell_shortcuts"

    printf "hash -d %s=%s\n" \
        "$key" "$expanded_path" >>"$zsh_named_dirs"

    printf "map E%s \\\$EDITOR \"%s\"\n" \
        "$key" "$expanded_path" >>"$lf_shortcuts"
done < <(read_bookmarks "$bmfiles")
