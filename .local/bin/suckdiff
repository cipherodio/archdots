#!/usr/bin/env bash
# Author: cipherodio
# Description: Generate per-branch diffs against main

set -euo pipefail

# TODO: Need to update this directories once im in suckless world again.
DOTFILES="$HOME/.local/work/diffs"
PROJECT="$(basename "$(pwd)")"

DIFFDIR="$DOTFILES/${PROJECT}_diffs"
OLDDIFFDIR="$DIFFDIR/old"

# Ensure we're on main and clean
git checkout main
make clean
rm -f config.h
git fetch origin
git reset --hard origin/main

# Prepare diff directories
mkdir -p "$OLDDIFFDIR" "$DIFFDIR"

# Archive old diffs
mv "$DIFFDIR"/*.diff "$OLDDIFFDIR"/ 2>/dev/null || true

# Generate diffs for each branch
while IFS= read -r branch; do
    [ "$branch" = "main" ] && continue
    git diff main.."$branch" >"$DIFFDIR/${PROJECT}_${branch}.diff"
done < <(
    git for-each-ref --format='%(refname:short)' refs/heads/
)
