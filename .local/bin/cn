#!/usr/bin/env bash
# Author: cipherodio
# Description: Personal notes script to search for specific
# file on specific directory, use:
# cn jj, cn ss, cn rr, cn ii
# Options:
# cn j - journal for current day
# cn s - create new story
# cn r - permanent notes
# cn i - quick notes

set -euo pipefail

# Paths
BASE_DIR="$HOME/hub/src/mdnotes"

JOURNAL_DIR="$BASE_DIR/journal"
STORIES_DIR="$BASE_DIR/stories"
REFERENCE_DIR="$BASE_DIR/reference"
INBOX_DIR="$BASE_DIR/inbox"

mkdir -p "$JOURNAL_DIR" "$STORIES_DIR" "$REFERENCE_DIR" "$INBOX_DIR"

# Date formats
META_DATE_FMT="%b %d, %Y %a"
FILE_DATE_FMT="%b-%d-%Y-%a"
TIME_FMT="%I:%M %p"

current_date=$(date +"$META_DATE_FMT")
current_time=$(date +"$TIME_FMT")

# Helpers
usage() {
    local BOLD BLUE GREEN CYAN DIM RESET

    BOLD=$(printf '\033[1m')
    BLUE=$(printf '\033[34m')
    GREEN=$(printf '\033[32m')
    CYAN=$(printf '\033[36m')
    DIM=$(printf '\033[2m')
    RESET=$(printf '\033[0m')

    printf "%sUsage:%s %scn%s %s[options]%s\n\n" \
        "$BOLD" "$RESET" "$BLUE" "$RESET" "$CYAN" "$RESET"

    printf "%sTo search for specific file on\n" "$DIM"
    printf "specific directory, use:%s\n" "$RESET"
    printf "  %scn jj%s, %scn ss%s,\n" "$GREEN" "$RESET" "$GREEN" "$RESET"
    printf "  %scn rr%s, %scn ii%s\n\n" "$GREEN" "$RESET" "$GREEN" "$RESET"

    printf "%sOptions:%s\n" "$BOLD" "$RESET"
    printf "  %scn j%s   - journal for current day\n" "$GREEN" "$RESET"
    printf "  %scn s%s   - create new story\n" "$GREEN" "$RESET"
    printf "  %scn r%s   - permanent notes\n" "$GREEN" "$RESET"
    printf "  %scn i%s   - quick note\n" "$GREEN" "$RESET"

    exit 0
}

prompt() {
    local label="$1"
    local value
    read -rp "$label: " value
    printf "%s\n" "$value"
}

slugify() {
    printf "%s\n" "$1" |
        tr '[:upper:]' '[:lower:]' |
        sed -E 's/[^a-z0-9]+/_/g; s/^_+|_+$//g'
}

open_editor() {
    exec "$EDITOR" "$1"
}

pick_and_open() {
    local dir="$1"

    local file
    file=$(find "$dir" -maxdepth 1 -type f |
        sed "s|$BASE_DIR/||" |
        fzf)

    [[ -n "$file" ]] && open_editor "$BASE_DIR/$file"
}

title_case() {
    printf "%s\n" "$1" | sed 's/.*/\u&/'
}

# Mode dispatch
mode="${1:-}"

[[ -z "$mode" ]] && usage

case "$mode" in
j)
    author="Jeremy"
    file_date=$(date +"$FILE_DATE_FMT" | tr '[:upper:]' '[:lower:]')
    file_date=${file_date/thu/thurs}

    filepath="$JOURNAL_DIR/$file_date.md"

    if [[ ! -e "$filepath" ]]; then
        cat >"$filepath" <<EOF
---
author: $author
date created: "$current_date"
time created: "$current_time"
---

EOF
    fi

    open_editor "$filepath"
    ;;

s)
    title=$(prompt "Title")
    author=$(prompt "Author")
    description=$(prompt "Description")
    filename_input=$(prompt "Filename (leave blank to use title)")

    slug=$(slugify "${filename_input:-$title}")
    filepath="$STORIES_DIR/$slug.md"

    if [[ ! -e "$filepath" ]]; then
        cat >"$filepath" <<EOF
---
title: $(title_case "$title")
author: $author
date created: "$current_date"
time created: "$current_time"
date completed: ""
date uploaded: ""
description: $description
---

EOF
    fi

    open_editor "$filepath"
    ;;

r)
    title=$(prompt "Title")
    author=$(prompt "Author")
    description=$(prompt "Description")
    filename_input=$(prompt "Filename (leave blank to use title)")

    slug=$(slugify "${filename_input:-$title}")
    filepath="$REFERENCE_DIR/$slug.md"

    cat >"$filepath" <<EOF
---
title: $(title_case "$title")
author: $author
date created: "$current_date"
time created: "$current_time"
description: $description
---

EOF

    open_editor "$filepath"
    ;;

i)
    title=$(prompt "Title")
    description=$(prompt "Description")
    filename_input=$(prompt "Filename (leave blank to use title)")
    author="Jeremy"

    slug=$(slugify "${filename_input:-$title}")
    filepath="$INBOX_DIR/$slug.md"

    cat >"$filepath" <<EOF
---
title: $(title_case "$title")
author: $author
date created: "$current_date"
time created: "$current_time"
description: $description
---

EOF

    open_editor "$filepath"
    ;;

jj) pick_and_open "$JOURNAL_DIR" ;;
ss) pick_and_open "$STORIES_DIR" ;;
rr) pick_and_open "$REFERENCE_DIR" ;;
ii) pick_and_open "$INBOX_DIR" ;;

*)
    usage
    ;;
esac
