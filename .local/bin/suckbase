#!/usr/bin/env bash
# Author: cipherodio
# Description: Rebase all local branches onto updated main

set -euo pipefail

# Ensure we are on main and fully reset
git checkout main
make clean
rm -f config.h
git fetch origin
git reset --hard origin/main
git pull --ff-only

# Rebase all other local branches onto main
while IFS= read -r branch; do
    [ "$branch" = "main" ] && continue
    git checkout "$branch"
    git rebase --preserve-merges main
done < <(
    git for-each-ref --format='%(refname:short)' refs/heads/
)

# Return to main
git checkout main
